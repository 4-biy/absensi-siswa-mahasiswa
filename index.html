<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ABSENSI MAHASISWA & SISWA</title>
    <style>
        #gform {
            margin: auto;
            border: blue solid 1px;
            width: 100%;
            height: 98vh;
            overflow: auto;
        }

        body,
        html {
            margin: 0;
            padding: 0;
            height: 100%;
        }

        .header {
            padding: 20px;
            text-align: center;
        }

        .header img {
            width: 100%;
            max-width: 600px;
            height: auto;
        }
    </style>
</head>

<body style="background-color: #eee">
    <iframe id="gform"
        src="https://docs.google.com/forms/d/e/1FAIpQLSeI9BB5WHCtQS-_4CsYjqjojoe8sBxQ1z_Dg4sLCCmWnNjjBQ/viewform?embedded=true&randomParam=<?= Math.random() ?>"
        style="width: 100%; border: none;"></iframe>

    <script type="text/javascript">
        var lat, lon;

        // Fungsi untuk mendapatkan lokasi
        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(success, error);
            } else {
                alert("Geolocation tidak didukung oleh browser ini.");
            }
        }

        // Fungsi ini akan dipanggil jika koordinat berhasil diperoleh
        function success(position) {
            lat = position.coords.latitude;
            lon = position.coords.longitude;

            // Hanya redirect jika lat dan lon valid
            if (isValidLocation(lat, lon)) {
                redirectToWebApp();
            } else {
                alert("Lokasi tidak valid. Tidak dapat melakukan absensi.");
            }
        }

        // Fungsi ini akan dipanggil jika ada kesalahan dalam mengambil koordinat
        function error(err) {
            console.warn(`ERROR(${err.code}): ${err.message}`);
            alert("Gagal mendapatkan lokasi. Pastikan izin lokasi sudah diberikan.");
        }

        // Memeriksa validitas lokasi
        function isValidLocation(lat, lon) {
            return (lat !== undefined && lon !== undefined);
        }

        // Redirect ke webapp
        function redirectToWebApp() {
            var url = `https://script.google.com/macros/s/AKfycbyna-jvb3KYxDVfqKitVuhBdP_zJgEDJxy_bEWZN-chjcv4lj3waZwxjQbP47whNLsOOg/exec?lat=${lat}&lon=${lon}`;

            // Menggunakan setTimeout untuk memberikan waktu untuk memproses pengalihan
            setTimeout(function () {
                window.location.href = url; // Menggunakan window.location.href untuk redirect
            }, 100); // Delay sedikit untuk stabilitas
        }

        // Panggil fungsi getLocation saat halaman dimuat
        window.onload = function () {
            // Tunggu hingga iframe dimuat sepenuhnya
            document.getElementById('gform').onload = function () {
                getLocation(); // Dapatkan lokasi saat iframe dimuat
            };
        };
    </script>
</body>

</html>
